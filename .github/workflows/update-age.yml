# .github/workflows/update-age.yml
name: Update Age in README

on:
  workflow_dispatch: {}
  schedule:
    # Summer (CEST, UTC+2): 00:00 Madrid = 22:00 UTC
    - cron: '0 22 * 4-10 *'
    # Winter (CET, UTC+1): 00:00 Madrid = 23:00 UTC
    - cron: '0 23 * 11,12,1,2,3 *'

permissions:
  contents: write

jobs:
  update-age:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute age and replace __AGE__
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: |
          python - << 'PY'
          from datetime import date
          import io,sys,re,os
          BIRTH = date(2003,1,22)
          today = date.today()
          age = today.year - BIRTH.year - ((today.month, today.day) < (BIRTH.month, BIRTH.day))
          print(f"[age] computed age = {age}")
          p = "README.md"
          with io.open(p, "r", encoding="utf-8") as f:
              s = f.read()
          s2 = re.sub(r"__AGE__", str(age), s)
          if s2 != s:
              with io.open(p, "w", encoding="utf-8", newline="\n") as f:
                  f.write(s2)
              print("[age] README.md updated")
          else:
              print("[age] No __AGE__ placeholder found or already correct")
          PY

      - name: Commit & push (safe)
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git add README.md
          git commit -m "chore: auto-update age in README"

          # sincroniza por si hubo cambios remotos
          BRANCH="${GITHUB_REF_NAME:-main}"
          git fetch origin "$BRANCH"
          git pull --rebase origin "$BRANCH" || true

          # push normal; si alguien moviÃ³ la rama entre medias, fuerza protegida
          git push origin HEAD:"$BRANCH" || git push --force-with-lease origin HEAD:"$BRANCH"

